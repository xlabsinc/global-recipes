<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Recipe Collection</title>
    <meta name="description" content="Explore 400+ authentic recipes from around the world - Indian, Asian, European, Middle Eastern, African, and more">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2em;
            color: #5a6c7d;
            font-weight: 500;
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 10px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .search-container input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1.1em;
            padding: 10px;
        }

        .search-icon {
            color: #667eea;
            font-size: 1.5em;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-btn {
            background: #f8f9fa;
            border: 2px solid #e1e4e8;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #495057;
            font-weight: 500;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            background: #f8f9ff;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .load-custom {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .loader-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .loader-content {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .loader-content.expanded {
            display: block;
        }

        .loader-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .loader-option {
            flex: 1;
            min-width: 250px;
        }

        .loader-option h4 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 0.95em;
        }

        .help-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .help-content {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .help-content.expanded {
            display: block;
        }

        .help-content h4 {
            color: #667eea;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .help-content pre {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #e0e0e0;
        }

        .help-content code {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .file-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        #loadStatus {
            text-align: center;
            font-size: 0.9em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .loaded-files {
            margin-top: 15px;
        }

        .loaded-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .loaded-files-header:hover {
            background: #e9ecef;
        }

        .loaded-files-title {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        .toggle-icon {
            font-size: 0.8em;
            color: #0071e3;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .file-controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            justify-content: center;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .file-controls.collapsed {
            display: none;
        }

        .file-list-container {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            border-top: 1px solid #e0e0e0;
        }

        .file-list-container.collapsed {
            display: none;
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
        }

        .file-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e8f4f8;
            border: 1px solid rgba(0, 114, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #005bb5;
        }

        .file-tag .recipe-count {
            background: #0071e3;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .file-tag .remove-btn {
            background: #f56565;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .file-tag .remove-btn:hover {
            background: #c53030;
        }

        .docked-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            border-top: 3px solid #667eea;
            box-shadow: 0 -4px 20px rgba(102, 126, 234, 0.25);
            padding: 15px 20px;
            z-index: 1000;
            max-height: 150px;
            overflow-x: auto;
            overflow-y: hidden;
            display: none;
            backdrop-filter: blur(10px);
        }

        .docked-area.active {
            display: block;
        }

        .docked-cards {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .docked-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .docked-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .docked-card-name {
            flex: 1;
            font-weight: 600;
            font-size: 0.95em;
        }

        .docked-card-actions {
            display: flex;
            gap: 6px;
        }

        .docked-card button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .docked-card button:hover {
            background: rgba(255,255,255,0.35);
        }

        .docked-card .restore-btn {
            font-size: 0.9em;
        }

        .docked-card .close-btn {
            background: rgba(220, 53, 69, 0.8);
        }

        .docked-card .close-btn:hover {
            background: rgba(220, 53, 69, 1);
        }

        .recipe-card.viewing {
            border: 3px solid #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .close-card-btn {
            background: rgba(220, 53, 69, 0.2);
            border: none;
            color: #dc3545;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .recipe-card.expanded .close-card-btn {
            display: flex;
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .close-card-btn:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        .recipe-card.expanded .close-card-btn:hover {
            background: rgba(220, 53, 69, 1);
        }

        .url-loader {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .url-input-group input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        .url-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .url-input-group button {
            padding: 10px 20px;
            white-space: nowrap;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        select.filter-select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select.filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .stats-text {
            flex: 1;
            text-align: center;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }

        /* Theme Popup Modal */
        .theme-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 3000;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }

        .theme-popup.active {
            display: block;
        }

        .theme-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            backdrop-filter: blur(4px);
        }

        .theme-popup-overlay.active {
            display: block;
        }

        .theme-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .theme-popup-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #2c3e50;
        }

        .theme-popup-close {
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-popup-close:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

        .theme-category {
            margin-bottom: 30px;
        }

        .theme-category-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .theme-item {
            background: #f8f9fa;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .theme-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .theme-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .theme-item.active::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            color: #667eea;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .theme-emoji {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .theme-name {
            font-size: 0.9em;
            font-weight: 600;
        }

        /* Theme Selector */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-btn {
            background: white;
            border: 2px solid #e1e4e8;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .theme-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }

        /* Preferences Controls */
        .pref-btn {
            background: white;
            border: 2px solid #e1e4e8;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .pref-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .recipe-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .recipe-card.expanded {
            position: fixed;
            top: 10vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90vw;
            width: 900px;
            height: 80vh;
            grid-column: initial;
            cursor: default;
            border-color: #667eea;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .recipe-card.expanded .recipe-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: move;
            flex-shrink: 0;
            user-select: none;
        }

        .recipe-card.expanded .recipe-header-left {
            cursor: move;
        }

        .recipe-card.expanded .recipe-body {
            flex-shrink: 0;
        }

        .recipe-card.expanded .expanded-content {
            flex: 1;
            overflow-y: auto;
            display: grid !important;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30px;
            height: 30px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, rgba(102, 126, 234, 0.7) 50%);
            z-index: 10;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            padding: 2px;
            font-size: 20px;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            user-select: none;
        }

        .recipe-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #2c3e50;
            padding: 20px;
            min-height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recipe-header-left {
            flex: 1;
        }

        .recipe-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .recipe-category {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .minimize-btn {
            background: rgba(102, 126, 234, 0.15);
            border: none;
            color: #667eea;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .recipe-card.expanded .minimize-btn {
            display: flex;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .minimize-btn:hover {
            background: rgba(102, 126, 234, 0.25);
        }

        .recipe-card.expanded .minimize-btn:hover {
            background: rgba(255,255,255,0.35);
        }

        .recipe-body {
            padding: 20px;
        }

        .recipe-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .recipe-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .tag {
            display: inline-block;
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            margin: 2px;
            color: #667eea;
        }

        .tag.veg {
            background: #d4edda;
            color: #155724;
        }

        .tag.non-veg {
            background: #f8d7da;
            color: #721c24;
        }

        .expanded-content {
            display: none;
            padding: 0 20px 20px;
        }

        .recipe-card.expanded .expanded-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .section h3 {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            font-weight: 700;
        }

        .ingredients-list {
            list-style: none;
            padding: 0;
        }

        .ingredients-list li {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
        }

        .ingredients-list li:before {
            content: "‚úì";
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.2em;
        }

        .instructions-list {
            list-style: none;
            counter-reset: step-counter;
            padding: 0;
        }

        .instructions-list li {
            padding: 15px;
            padding-left: 60px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            counter-increment: step-counter;
            position: relative;
            line-height: 1.6;
        }

        .instructions-list li:before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 15px;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .no-results {
            text-align: center;
            color: #495057;
            font-size: 1.5em;
            padding: 50px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* Tag Filter Styles */
        .tag-filter-container {
            margin-bottom: 15px;
        }

        .tag-input-wrapper {
            position: relative;
            background: white;
            border: 2px solid #e1e4e8;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 45px;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag-chip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: tagAppear 0.2s ease;
        }

        @keyframes tagAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        .tag-chip-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            font-size: 1.2em;
            line-height: 1;
        }

        .tag-chip-remove:hover {
            opacity: 1;
        }

        #tagInput {
            flex: 1;
            min-width: 150px;
            border: none;
            outline: none;
            font-size: 0.9em;
            padding: 5px;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: -2px;
        }

        .tag-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .tag-suggestion-item:last-child {
            border-bottom: none;
        }

        .tag-suggestion-item:hover {
            background: #f8f9ff;
        }

        .tag-suggestion-item.highlight {
            background: #e8ecff;
        }

        /* Close button on cards */
        .close-card-mini-btn {
            background: rgba(220, 53, 69, 0.15);
            border: none;
            color: #dc3545;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            line-height: 1;
            opacity: 0.7;
        }

        .close-card-mini-btn:hover {
            background: rgba(220, 53, 69, 0.25);
            opacity: 1;
            transform: scale(1.1);
        }

        .recipe-name {
            cursor: pointer;
            transition: color 0.2s;
        }

        .recipe-name:hover {
            color: #667eea;
        }

        .recipe-card.expanded .recipe-name:hover {
            color: white;
            opacity: 0.9;
        }

        /* File checkbox styles */
        .file-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
            flex-shrink: 0;
        }

        .file-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Display controls */
        .display-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        @media (max-width: 1400px) {
            .recipe-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1100px) {
            .recipe-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 968px) {
            .recipe-card.expanded .expanded-content {
                grid-template-columns: 1fr;
            }

            .recipe-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .recipe-grid {
                grid-template-columns: 1fr;
            }

            .theme-selector {
                right: 10px;
            }

            .pref-btn {
                padding: 8px 14px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Selector & Preferences -->
    <div class="theme-selector">
        <button class="theme-btn" onclick="openThemePopup()">üé® Theme</button>
        <button class="pref-btn" onclick="sharePreferences()" title="Share current search & filters">üîó Share</button>
        <button class="pref-btn" onclick="clearPreferences()" title="Clear saved preferences">üóëÔ∏è Clear Prefs</button>
    </div>

    <!-- Theme Popup -->
    <div class="theme-popup-overlay" id="themeOverlay" onclick="closeThemePopup()"></div>
    <div class="theme-popup" id="themePopup">
        <div class="theme-popup-header">
            <div class="theme-popup-title">üé® Choose Theme</div>
            <button class="theme-popup-close" onclick="closeThemePopup()">√ó</button>
        </div>

        <div class="theme-category">
            <div class="theme-category-title">‚òÄÔ∏è Classic Themes</div>
            <div class="theme-grid">
                <div class="theme-item" onclick="selectTheme('light')" data-theme="light">
                    <div class="theme-emoji">‚òÄÔ∏è</div>
                    <div class="theme-name">Light</div>
                </div>
                <div class="theme-item" onclick="selectTheme('dark')" data-theme="dark">
                    <div class="theme-emoji">üåô</div>
                    <div class="theme-name">Dark</div>
                </div>
            </div>
        </div>

        <div class="theme-category">
            <div class="theme-category-title">üåà Nature Themes</div>
            <div class="theme-grid">
                <div class="theme-item" onclick="selectTheme('blue')" data-theme="blue">
                    <div class="theme-emoji">üíô</div>
                    <div class="theme-name">Ocean Blue</div>
                </div>
                <div class="theme-item" onclick="selectTheme('green')" data-theme="green">
                    <div class="theme-emoji">üíö</div>
                    <div class="theme-name">Forest Green</div>
                </div>
                <div class="theme-item" onclick="selectTheme('teal')" data-theme="teal">
                    <div class="theme-emoji">üåä</div>
                    <div class="theme-name">Teal Wave</div>
                </div>
                <div class="theme-item" onclick="selectTheme('mint')" data-theme="mint">
                    <div class="theme-emoji">üçÉ</div>
                    <div class="theme-name">Mint Fresh</div>
                </div>
                <div class="theme-item" onclick="selectTheme('sage')" data-theme="sage">
                    <div class="theme-emoji">üåø</div>
                    <div class="theme-name">Sage</div>
                </div>
                <div class="theme-item" onclick="selectTheme('sky')" data-theme="sky">
                    <div class="theme-emoji">‚òÅÔ∏è</div>
                    <div class="theme-name">Sky</div>
                </div>
            </div>
        </div>

        <div class="theme-category">
            <div class="theme-category-title">üå∫ Warm Themes</div>
            <div class="theme-grid">
                <div class="theme-item" onclick="selectTheme('orange')" data-theme="orange">
                    <div class="theme-emoji">üß°</div>
                    <div class="theme-name">Sunset Orange</div>
                </div>
                <div class="theme-item" onclick="selectTheme('gold')" data-theme="gold">
                    <div class="theme-emoji">‚≠ê</div>
                    <div class="theme-name">Golden Hour</div>
                </div>
                <div class="theme-item" onclick="selectTheme('crimson')" data-theme="crimson">
                    <div class="theme-emoji">üåπ</div>
                    <div class="theme-name">Crimson Red</div>
                </div>
                <div class="theme-item" onclick="selectTheme('coral')" data-theme="coral">
                    <div class="theme-emoji">ü™∏</div>
                    <div class="theme-name">Coral</div>
                </div>
            </div>
        </div>

        <div class="theme-category">
            <div class="theme-category-title">üíê Vibrant Themes</div>
            <div class="theme-grid">
                <div class="theme-item" onclick="selectTheme('purple')" data-theme="purple">
                    <div class="theme-emoji">üíú</div>
                    <div class="theme-name">Royal Purple</div>
                </div>
                <div class="theme-item" onclick="selectTheme('lavender')" data-theme="lavender">
                    <div class="theme-emoji">ü™ª</div>
                    <div class="theme-name">Lavender</div>
                </div>
                <div class="theme-item" onclick="selectTheme('pink')" data-theme="pink">
                    <div class="theme-emoji">üå∏</div>
                    <div class="theme-name">Cherry Blossom</div>
                </div>
                <div class="theme-item" onclick="selectTheme('rose')" data-theme="rose">
                    <div class="theme-emoji">üå∑</div>
                    <div class="theme-name">Rose</div>
                </div>
                <div class="theme-item" onclick="selectTheme('indigo')" data-theme="indigo">
                    <div class="theme-emoji">üîÆ</div>
                    <div class="theme-name">Indigo</div>
                </div>
                <div class="theme-item" onclick="selectTheme('magenta')" data-theme="magenta">
                    <div class="theme-emoji">üíó</div>
                    <div class="theme-name">Magenta</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üåç Global Recipe Collection</h1>
            <p class="subtitle">Discover 400+ authentic recipes from around the world</p>
        </header>

        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search by recipe name or ingredient... (e.g., dosa, coconut, chicken)">
        </div>

        <div class="controls">
            <div class="tag-filter-container">
                <span class="filter-label">Tags:</span>
                <div class="tag-input-wrapper">
                    <div class="selected-tags" id="selectedTags"></div>
                    <input type="text" id="tagInput" placeholder="Type to filter by tags..." autocomplete="off">
                    <div class="tag-suggestions" id="tagSuggestions" style="display: none;"></div>
                </div>
            </div>

            <div class="display-controls">
                <span class="filter-label">Show:</span>
                <select id="itemsPerPageSelect" class="filter-select">
                    <option value="5">5 items</option>
                    <option value="10" selected>10 items</option>
                    <option value="20">20 items</option>
                    <option value="30">30 items</option>
                    <option value="50">50 items</option>
                    <option value="all">All items</option>
                </select>
            </div>

            <div class="filters" id="filters"></div>

            <div class="load-custom">
                <div class="loader-toggle">
                    <button class="filter-btn" onclick="toggleLoader()">
                        üìÅ Load Recipes
                    </button>
                    <button class="filter-btn" onclick="toggleHelp()">
                        ‚ùì Help
                    </button>
                </div>

                <div class="loader-content" id="loaderContent">
                    <div class="loader-options">
                        <div class="loader-option">
                            <h4>üìÇ Load from Computer</h4>
                            <input type="file" id="customJsonFile" accept=".json" multiple style="display: none;">
                            <button class="filter-btn" onclick="document.getElementById('customJsonFile').click()">
                                Choose Files
                            </button>
                        </div>
                        <div class="loader-option">
                            <h4>üåê Load from URL</h4>
                            <div class="url-input-group">
                                <input type="url" id="urlInput" placeholder="Enter JSON URL (e.g., GitHub Gist)">
                                <button class="filter-btn" onclick="loadFromURL()">Load</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-content" id="helpContent">
                        <h4>üìã JSON Recipe File Structure</h4>
                        <p>Your JSON file should be an array of recipe objects with this structure:</p>
                        <pre><code>[
  {
    "name": "Recipe Name",
    "category": "Breakfast",
    "type": "Vegetarian",
    "difficulty": "Easy",
    "prepTime": 15,
    "cookTime": 20,
    "servings": 4,
    "emoji": "üçõ",
    "description": "Brief description of the dish",
    "ingredients": [
      "2 cups flour",
      "1 cup water",
      "Salt to taste"
    ],
    "instructions": [
      "Step 1: Do this",
      "Step 2: Do that",
      "Step 3: Serve hot"
    ],
    "tags": ["Quick", "Easy", "Popular"]
  }
]</code></pre>

                        <h4>üîë Required Fields</h4>
                        <ul>
                            <li><strong>name:</strong> Recipe name (string)</li>
                            <li><strong>category:</strong> Breakfast, Main Course, Curry, Rice, Snack, Dessert, Side Dish, Soup, Bread</li>
                            <li><strong>type:</strong> "Vegetarian" or "Non-Vegetarian"</li>
                            <li><strong>difficulty:</strong> "Easy", "Medium", or "Hard"</li>
                            <li><strong>prepTime:</strong> Preparation time in minutes (number)</li>
                            <li><strong>cookTime:</strong> Cooking time in minutes (number)</li>
                            <li><strong>servings:</strong> Number of servings (number)</li>
                            <li><strong>ingredients:</strong> Array of ingredient strings</li>
                            <li><strong>instructions:</strong> Array of instruction strings</li>
                        </ul>

                        <h4>üì¶ Optional Fields</h4>
                        <ul>
                            <li><strong>id:</strong> Unique identifier (auto-generated from filename if missing - no need to add!)</li>
                            <li><strong>emoji:</strong> Emoji icon for the recipe</li>
                            <li><strong>description:</strong> Short description</li>
                            <li><strong>tags:</strong> Array of tag strings</li>
                        </ul>

                        <h4>üí° Tips</h4>
                        <ul>
                            <li>Validate your JSON at <a href="https://jsonlint.com" target="_blank">jsonlint.com</a></li>
                            <li>Use GitHub Gist for sharing recipes</li>
                            <li>Keep ingredient measurements clear</li>
                            <li>Number your instructions for clarity</li>
                            <li><strong>No need to add "id" field</strong> - it's automatically generated!</li>
                        </ul>
                    </div>
                </div>

                <div id="loadStatus"></div>

                <div class="loaded-files" id="loadedFilesSection" style="display: none;">
                    <div class="loaded-files-header" onclick="toggleLoadedFiles()">
                        <span class="loaded-files-title">Loaded Files</span>
                        <span class="toggle-icon collapsed" id="filesToggleIcon">‚ñº</span>
                    </div>
                    <div class="file-controls collapsed" id="fileControls">
                        <button class="filter-btn" onclick="selectAllFiles()">Select All</button>
                        <button class="filter-btn" onclick="deselectAllFiles()">Deselect All</button>
                    </div>
                    <div class="file-list-container collapsed" id="fileListContainer">
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stats-text">
                Showing <span id="recipeCount">0</span> of <span id="totalCount">0</span> recipes
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn" onclick="previousPage()" disabled>‚Üê Previous</button>
                <span class="page-info" id="pageInfo">Page 1</span>
                <button class="pagination-btn" id="nextBtn" onclick="nextPage()" disabled>Next ‚Üí</button>
            </div>
        </div>

        <div class="recipe-grid" id="recipeGrid"></div>

        <div class="no-results" id="noResults" style="display: none;">
            No recipes found. Try a different search term!
        </div>
    </div>

    <!-- Docked Minimized Cards Area -->
    <div class="docked-area" id="dockedArea">
        <div class="docked-cards" id="dockedCards"></div>
    </div>

    <script>
        let recipes = [];
        let filteredRecipes = [];
        let currentFilter = 'All';
        let itemsPerPage = 10; // Changed from MAX_INITIAL_DISPLAY = 30
        let selectedTags = [];
        let allTags = new Set();
        let dismissedCards = new Set();
        let currentPage = 1;
        let currentTheme = 'light';

        // Track loaded files and their recipes
        let loadedFiles = new Map(); // filename -> {recipes: [], builtIn: boolean, visible: boolean}

        // Track docked (minimized) cards
        let dockedCards = new Map(); // recipeId -> recipe object

        // Track highest z-index for floating cards
        let highestZIndex = 1000;

        // Bring element to front
        function bringToFront(element) {
            highestZIndex++;
            element.style.zIndex = highestZIndex;
        }

        // Theme definitions
        const themes = {
            light: {
                bg: 'linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%)',
                cardBg: '#ffffff',
                text: '#2c3e50',
                headerBg: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                accent: '#667eea',
                accentHover: '#5568d3',
                buttonBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                filterBtnActive: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
            },
            dark: {
                bg: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                cardBg: '#0f3460',
                text: '#e9ecef',
                headerBg: 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                accent: '#667eea',
                accentHover: '#5568d3',
                buttonBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                filterBtnActive: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
            },
            blue: {
                bg: 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)',
                cardBg: '#ffffff',
                text: '#0c4a6e',
                headerBg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #0284c7 0%, #0369a1 100%)',
                accent: '#0284c7',
                accentHover: '#0369a1',
                buttonBg: 'linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%)',
                filterBtnActive: 'linear-gradient(135deg, #0284c7 0%, #0369a1 100%)'
            },
            green: {
                bg: 'linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)',
                cardBg: '#ffffff',
                text: '#14532d',
                headerBg: 'linear-gradient(135deg, #d9f99d 0%, #bef264 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)',
                accent: '#16a34a',
                accentHover: '#15803d',
                buttonBg: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                filterBtnActive: 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)'
            },
            orange: {
                bg: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)',
                cardBg: '#ffffff',
                text: '#7c2d12',
                headerBg: 'linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #ea580c 0%, #c2410c 100%)',
                accent: '#ea580c',
                accentHover: '#c2410c',
                buttonBg: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
                filterBtnActive: 'linear-gradient(135deg, #ea580c 0%, #c2410c 100%)'
            },
            purple: {
                bg: 'linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%)',
                cardBg: '#ffffff',
                text: '#581c87',
                headerBg: 'linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #9333ea 0%, #7e22ce 100%)',
                accent: '#9333ea',
                accentHover: '#7e22ce',
                buttonBg: 'linear-gradient(135deg, #a855f7 0%, #9333ea 100%)',
                filterBtnActive: 'linear-gradient(135deg, #9333ea 0%, #7e22ce 100%)'
            },
            pink: {
                bg: 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%)',
                cardBg: '#ffffff',
                text: '#831843',
                headerBg: 'linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #db2777 0%, #be185d 100%)',
                accent: '#db2777',
                accentHover: '#be185d',
                buttonBg: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)',
                filterBtnActive: 'linear-gradient(135deg, #db2777 0%, #be185d 100%)'
            },
            teal: {
                bg: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%)',
                cardBg: '#ffffff',
                text: '#134e4a',
                headerBg: 'linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #0d9488 0%, #0f766e 100%)',
                accent: '#0d9488',
                accentHover: '#0f766e',
                buttonBg: 'linear-gradient(135deg, #14b8a6 0%, #0d9488 100%)',
                filterBtnActive: 'linear-gradient(135deg, #0d9488 0%, #0f766e 100%)'
            },
            crimson: {
                bg: 'linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%)',
                cardBg: '#ffffff',
                text: '#881337',
                headerBg: 'linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #e11d48 0%, #be123c 100%)',
                accent: '#e11d48',
                accentHover: '#be123c',
                buttonBg: 'linear-gradient(135deg, #f43f5e 0%, #e11d48 100%)',
                filterBtnActive: 'linear-gradient(135deg, #e11d48 0%, #be123c 100%)'
            },
            gold: {
                bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                cardBg: '#ffffff',
                text: '#78350f',
                headerBg: 'linear-gradient(135deg, #fefce8 0%, #fef3c7 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #d97706 0%, #b45309 100%)',
                accent: '#d97706',
                accentHover: '#b45309',
                buttonBg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                filterBtnActive: 'linear-gradient(135deg, #d97706 0%, #b45309 100%)'
            },
            mint: {
                bg: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)',
                cardBg: '#ffffff',
                text: '#064e3b',
                headerBg: 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #059669 0%, #047857 100%)',
                accent: '#059669',
                accentHover: '#047857',
                buttonBg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                filterBtnActive: 'linear-gradient(135deg, #059669 0%, #047857 100%)'
            },
            lavender: {
                bg: 'linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%)',
                cardBg: '#ffffff',
                text: '#5b21b6',
                headerBg: 'linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)',
                accent: '#7c3aed',
                accentHover: '#6d28d9',
                buttonBg: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                filterBtnActive: 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)'
            },
            sage: {
                bg: 'linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%)',
                cardBg: '#ffffff',
                text: '#1f2937',
                headerBg: 'linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)',
                accent: '#6b7280',
                accentHover: '#4b5563',
                buttonBg: 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)',
                filterBtnActive: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'
            },
            sky: {
                bg: 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)',
                cardBg: '#ffffff',
                text: '#075985',
                headerBg: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #0284c7 0%, #075985 100%)',
                accent: '#0284c7',
                accentHover: '#075985',
                buttonBg: 'linear-gradient(135deg, #38bdf8 0%, #0284c7 100%)',
                filterBtnActive: 'linear-gradient(135deg, #0284c7 0%, #075985 100%)'
            },
            coral: {
                bg: 'linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%)',
                cardBg: '#ffffff',
                text: '#9f1239',
                headerBg: 'linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #fb7185 0%, #f43f5e 100%)',
                accent: '#fb7185',
                accentHover: '#f43f5e',
                buttonBg: 'linear-gradient(135deg, #fda4af 0%, #fb7185 100%)',
                filterBtnActive: 'linear-gradient(135deg, #fb7185 0%, #f43f5e 100%)'
            },
            rose: {
                bg: 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%)',
                cardBg: '#ffffff',
                text: '#9f1239',
                headerBg: 'linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)',
                accent: '#ec4899',
                accentHover: '#db2777',
                buttonBg: 'linear-gradient(135deg, #f9a8d4 0%, #ec4899 100%)',
                filterBtnActive: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)'
            },
            indigo: {
                bg: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%)',
                cardBg: '#ffffff',
                text: '#3730a3',
                headerBg: 'linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
                accent: '#6366f1',
                accentHover: '#4f46e5',
                buttonBg: 'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)',
                filterBtnActive: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)'
            },
            magenta: {
                bg: 'linear-gradient(135deg, #fae8ff 0%, #f5d0fe 100%)',
                cardBg: '#ffffff',
                text: '#86198f',
                headerBg: 'linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%)',
                headerExpandedBg: 'linear-gradient(135deg, #c026d3 0%, #a21caf 100%)',
                accent: '#c026d3',
                accentHover: '#a21caf',
                buttonBg: 'linear-gradient(135deg, #d946ef 0%, #c026d3 100%)',
                filterBtnActive: 'linear-gradient(135deg, #c026d3 0%, #a21caf 100%)'
            }
        };

        // Theme popup functions
        function openThemePopup() {
            document.getElementById('themePopup').classList.add('active');
            document.getElementById('themeOverlay').classList.add('active');
            updateActiveTheme();
        }

        function closeThemePopup() {
            document.getElementById('themePopup').classList.remove('active');
            document.getElementById('themeOverlay').classList.remove('active');
        }

        function updateActiveTheme() {
            document.querySelectorAll('.theme-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.theme === currentTheme) {
                    item.classList.add('active');
                }
            });
        }

        function selectTheme(themeName) {
            setTheme(themeName);
            updateActiveTheme();
            // Don't close popup immediately - let user see the change
            setTimeout(() => {
                closeThemePopup();
            }, 300);
        }

        // Set theme
        function setTheme(themeName) {
            currentTheme = themeName;
            const theme = themes[themeName];
            document.body.style.background = theme.bg;

            // Update all cards
            document.querySelectorAll('.recipe-card').forEach(card => {
                if (!card.classList.contains('expanded')) {
                    card.style.background = theme.cardBg;
                    card.style.color = theme.text;
                }
            });

            // Update card headers (non-expanded)
            document.querySelectorAll('.recipe-card:not(.expanded) .recipe-header').forEach(header => {
                header.style.background = theme.headerBg;
                header.style.color = theme.text;
            });

            // Update expanded card headers
            document.querySelectorAll('.recipe-card.expanded .recipe-header').forEach(header => {
                header.style.background = theme.headerExpandedBg;
                header.style.color = 'white';
            });

            // Update main containers
            document.querySelectorAll('header, .controls, .stats').forEach(el => {
                el.style.background = theme.cardBg;
                el.style.color = theme.text;
            });

            // Update buttons with accent colors
            document.querySelectorAll('.pagination-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.style.background = theme.buttonBg;
                }
            });

            // Update active filter buttons
            document.querySelectorAll('.filter-btn.active').forEach(btn => {
                btn.style.background = theme.filterBtnActive;
                btn.style.color = 'white';
                btn.style.borderColor = 'transparent';
            });

            // Update accent colors throughout
            const style = document.createElement('style');
            style.id = 'theme-accent-style';
            // Remove old theme style if exists
            const oldStyle = document.getElementById('theme-accent-style');
            if (oldStyle) oldStyle.remove();

            style.innerHTML = `
                .page-info { color: ${theme.accent} !important; }
                .search-icon { color: ${theme.accent} !important; }
                .filter-label { color: ${theme.text} !important; }
                .tag { color: ${theme.accent} !important; }
                .section h3 { color: ${theme.accent} !important; border-bottom-color: ${theme.accent} !important; }
                .ingredients-list li:before { color: ${theme.accent} !important; }
                .instructions-list li:before { background: ${theme.buttonBg} !important; }
                .tag-chip { background: ${theme.buttonBg} !important; }
                .docked-card { background: ${theme.buttonBg} !important; }
                .filter-btn:hover { border-color: ${theme.accent} !important; }
                .theme-menu { border-color: ${theme.accent} !important; }
            `;
            document.head.appendChild(style);

            // Mark active theme
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            localStorage.setItem('selectedTheme', themeName);
            document.getElementById('themeMenu').style.display = 'none';

            // Save preferences
            savePreferences();
        }

        // Pagination functions
        function updatePagination() {
            const totalPages = Math.ceil(filteredRecipes.length / itemsPerPage);
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');

            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredRecipes.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
            }
        }

        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            displayRecipes(filteredRecipes.slice(startIndex, endIndex));
            updateStats();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // File selection functions
        function selectAllFiles() {
            loadedFiles.forEach((fileData, filename) => {
                fileData.visible = true;
            });
            updateFileList();
            filterRecipes();
        }

        function deselectAllFiles() {
            loadedFiles.forEach((fileData, filename) => {
                fileData.visible = false;
            });
            updateFileList();
            filterRecipes();
        }

        // Toggle loader content
        function toggleLoader() {
            const loaderContent = document.getElementById('loaderContent');
            const helpContent = document.getElementById('helpContent');
            loaderContent.classList.toggle('expanded');
            if (loaderContent.classList.contains('expanded')) {
                helpContent.classList.remove('expanded');
            }
        }

        // Toggle help content
        function toggleHelp() {
            const helpContent = document.getElementById('helpContent');
            const loaderContent = document.getElementById('loaderContent');
            helpContent.classList.toggle('expanded');
            if (helpContent.classList.contains('expanded')) {
                loaderContent.classList.remove('expanded');
            }
        }

        // Toggle loaded files section
        function toggleLoadedFiles() {
            const fileListContainer = document.getElementById('fileListContainer');
            const fileControls = document.getElementById('fileControls');
            const toggleIcon = document.getElementById('filesToggleIcon');
            fileListContainer.classList.toggle('collapsed');
            fileControls.classList.toggle('collapsed');
            toggleIcon.classList.toggle('collapsed');
        }

        // Tag filter functions
        function extractAllTags() {
            allTags.clear();
            recipes.forEach(recipe => {
                if (recipe.tags) {
                    recipe.tags.forEach(tag => allTags.add(tag));
                }
            });
        }

        function showTagSuggestions(input) {
            const value = input.toLowerCase().trim();
            if (!value) {
                hideTagSuggestions();
                return;
            }

            const matches = Array.from(allTags)
                .filter(tag => tag.toLowerCase().includes(value) && !selectedTags.includes(tag))
                .sort()
                .slice(0, 15);

            if (matches.length === 0) {
                hideTagSuggestions();
                return;
            }

            const suggestionsEl = document.getElementById('tagSuggestions');
            suggestionsEl.innerHTML = matches.map(tag =>
                `<div class="tag-suggestion-item" onclick="addTag('${tag.replace(/'/g, "\\'")}')">${tag}</div>`
            ).join('');
            suggestionsEl.style.display = 'block';
        }

        function hideTagSuggestions() {
            document.getElementById('tagSuggestions').style.display = 'none';
        }

        function addTag(tag) {
            if (!selectedTags.includes(tag)) {
                selectedTags.push(tag);
                renderSelectedTags();
                filterRecipes();
                savePreferences(); // Save when tag added
            }
            document.getElementById('tagInput').value = '';
            hideTagSuggestions();
        }

        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            renderSelectedTags();
            filterRecipes();
            savePreferences(); // Save when tag removed
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = selectedTags.map(tag => `
                <div class="tag-chip">
                    <span>${tag}</span>
                    <span class="tag-chip-remove" onclick="removeTag('${tag.replace(/'/g, "\\'")}')" title="Remove tag">√ó</span>
                </div>
            `).join('');
        }

        // Items per page handler
        function changeItemsPerPage() {
            const select = document.getElementById('itemsPerPageSelect');
            const value = select.value;
            itemsPerPage = value === 'all' ? filteredRecipes.length : parseInt(value);
            currentPage = 1; // Reset to first page
            displayCurrentPage();
            savePreferences(); // Save when items per page changes
        }

        // Dismiss card function
        function dismissCard(id) {
            dismissedCards.add(id);
            const card = document.getElementById(`recipe-${id}`);
            if (card) {
                card.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
            }
        }

        // Load from remote URL
        async function loadFromURL() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();

            if (!url) {
                updateLoadStatus('‚ùå Please enter a URL', 'error');
                return;
            }

            try {
                updateLoadStatus('‚è≥ Loading from URL...', 'info');

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    updateLoadStatus('‚ùå Invalid format. Expected an array of recipes.', 'error');
                    return;
                }

                // Extract filename from URL
                const filename = url.split('/').pop().split('?')[0] || 'remote-file.json';

                // Auto-generate IDs if missing
                data.forEach((recipe, index) => {
                    if (!recipe.id) {
                        // Generate unique ID based on filename and index
                        const filePrefix = filename.replace('.json', '');
                        recipe.id = `${filePrefix}-${index}`;
                    }
                });

                // Track this file
                loadedFiles.set(filename, {
                    recipes: data,
                    builtIn: false
                });

                // Update everything
                recipes = Array.from(loadedFiles.values()).flatMap(f => f.recipes);
                filterRecipes();
                setupFilters();
                updateFileList();
                updateLoadStatus(`‚úì Loaded ${data.length} recipes from ${filename}`, 'success');

                // Clear input
                urlInput.value = '';
            } catch (error) {
                console.error('Error loading from URL:', error);
                updateLoadStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Load recipes from multiple JSON files
        // Supports loading from local files OR a remote base URL
        // To load from a remote URL (e.g., GitHub raw or Gist), set the BASE_URL below
        // Example: 'https://gist.githubusercontent.com/username/gist-id/raw/'
        async function loadRecipes() {
            try {
                // CONFIGURATION: Set to empty string '' for local files
                // Or set to a remote URL base path (must end with /)
                // Example: 'https://raw.githubusercontent.com/username/repo/main/'
                // Example: 'https://gist.githubusercontent.com/username/gist-id/raw/'
                const BASE_URL = '';  // Empty for local files

                const jsonFiles = [
                    'recipes/recipes-south-01.json',
                    'recipes/recipes-south-02.json',
                    'recipes/recipes-south-03.json',
                    'recipes/recipes-south-04.json',
                    'recipes/recipes-south-05.json',
                    'recipes/recipes-south-06.json',
                    'recipes/recipes-south-07.json',
                    'recipes/recipes-south-08.json',
                    'recipes/recipes-south-09.json',
                    'recipes/recipes-south-10.json',
                    'recipes/recipes-north-01.json',
                    'recipes/recipes-north-02.json',
                    'recipes/recipes-north-03.json',
                    'recipes/recipes-north-04.json',
                    'recipes/recipes-north-05.json',
                    'recipes/recipes-other-01.json',
                    'recipes/recipes-chinese-01.json',
                    'recipes/recipes-chinese-02.json',
                    'recipes/recipes-vietnamese-01.json',
                    'recipes/recipes-vietnamese-02.json',
                    'recipes/recipes-korean-01.json',
                    'recipes/recipes-korean-02.json',
                    'recipes/recipes-thai-01.json',
                    'recipes/recipes-thai-02.json',
                    'recipes/recipes-japanese-01.json',
                    'recipes/recipes-japanese-02.json',
                    'recipes/recipes-european-01.json',
                    'recipes/recipes-european-02.json',
                    'recipes/recipes-british-01.json',
                    'recipes/recipes-british-02.json',
                    'recipes/recipes-american-01.json',
                    'recipes/recipes-american-02.json',
                    'recipes/recipes-iranian-01.json',
                    'recipes/recipes-iranian-02.json',
                    'recipes/recipes-middleeastern-01.json',
                    'recipes/recipes-middleeastern-02.json',
                    'recipes/recipes-australian-01.json',
                    'recipes/recipes-australian-02.json',
                    'recipes/recipes-african-01.json',
                    'recipes/recipes-african-02.json'
                ];

                let totalLoaded = 0;

                for (const file of jsonFiles) {
                    try {
                        const fileUrl = BASE_URL + file;
                        const response = await fetch(fileUrl);
                        const data = await response.json();

                        // Auto-generate IDs if missing
                        data.forEach((recipe, index) => {
                            if (!recipe.id) {
                                // Generate unique ID based on filename and index
                                const filePrefix = file.replace('recipes/', '').replace('.json', '');
                                recipe.id = `${filePrefix}-${index}`;
                            }
                        });

                        // Track this file
                        loadedFiles.set(file, {
                            recipes: data,
                            builtIn: true
                        });

                        totalLoaded += data.length;
                        console.log(`Loaded ${data.length} recipes from ${fileUrl}`);
                    } catch (error) {
                        console.error(`Error loading ${file}:`, error);
                    }
                }

                // Combine all recipes
                recipes = Array.from(loadedFiles.values()).flatMap(f => f.recipes);
                filteredRecipes = recipes;

                setupFilters();
                displayRecipes(filteredRecipes.slice(0, itemsPerPage));
                updateStats();
                updateFileList();
                extractAllTags();
                updateLoadStatus(`‚úì Loaded ${totalLoaded} recipes from ${jsonFiles.length} files`, 'success');
            } catch (error) {
                console.error('Error loading recipes:', error);
                updateLoadStatus('‚ùå Error loading recipes', 'error');
            }
        }

        // Load custom JSON files (supports multiple files)
        document.getElementById('customJsonFile').addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            let totalAdded = 0;
            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const customRecipes = JSON.parse(e.target.result);

                        if (Array.isArray(customRecipes)) {
                            // Auto-generate IDs if missing
                            customRecipes.forEach((recipe, index) => {
                                if (!recipe.id) {
                                    // Generate unique ID based on filename and index
                                    const filePrefix = file.name.replace('.json', '');
                                    recipe.id = `${filePrefix}-${index}`;
                                }
                            });

                            // Track this file
                            loadedFiles.set(file.name, {
                                recipes: customRecipes,
                                builtIn: false
                            });

                            totalAdded += customRecipes.length;
                            filesProcessed++;

                            // Update UI after all files processed
                            if (filesProcessed === files.length) {
                                recipes = Array.from(loadedFiles.values()).flatMap(f => f.recipes);
                                filterRecipes();
                                setupFilters();
                                updateFileList();
                                updateLoadStatus(`‚úì Added ${totalAdded} recipes from ${files.length} file(s)`, 'success');
                            }
                        } else {
                            updateLoadStatus(`‚ùå Invalid format in ${file.name}. Expected an array of recipes.`, 'error');
                        }
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        updateLoadStatus(`‚ùå Error parsing ${file.name}`, 'error');
                    }
                };
                reader.readAsText(file);
            });

            // Reset file input
            event.target.value = '';
        });

        // Remove a loaded file
        function removeFile(filename) {
            if (loadedFiles.has(filename)) {
                loadedFiles.delete(filename);

                // Recombine recipes
                recipes = Array.from(loadedFiles.values()).flatMap(f => f.recipes);

                // Refilter and update UI
                filterRecipes();
                setupFilters();
                updateFileList();
                updateLoadStatus(`‚úì Removed ${filename}`, 'success');
            }
        }

        // Update the file list display
        function updateFileList() {
            const fileListEl = document.getElementById('fileList');
            const sectionEl = document.getElementById('loadedFilesSection');

            if (loadedFiles.size === 0) {
                sectionEl.style.display = 'none';
                return;
            }

            sectionEl.style.display = 'block';
            fileListEl.innerHTML = '';

            loadedFiles.forEach((fileData, filename) => {
                const fileTag = document.createElement('div');
                fileTag.className = 'file-tag';

                // Add checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = fileData.visible !== false;
                checkbox.className = 'file-checkbox';
                checkbox.onchange = (e) => {
                    e.stopPropagation();
                    toggleFileVisibility(filename, e.target.checked);
                };

                const nameSpan = document.createElement('span');
                nameSpan.textContent = filename;

                const countSpan = document.createElement('span');
                countSpan.className = 'recipe-count';
                countSpan.textContent = fileData.recipes.length;

                fileTag.appendChild(checkbox);
                fileTag.appendChild(nameSpan);
                fileTag.appendChild(countSpan);

                // Only show remove button for non-built-in files or allow removing built-in too
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = '√ó';
                removeBtn.title = `Remove ${filename}`;
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Remove ${filename} and its ${fileData.recipes.length} recipes?`)) {
                        removeFile(filename);
                    }
                };
                fileTag.appendChild(removeBtn);

                fileListEl.appendChild(fileTag);
            });
        }

        // Toggle file visibility
        function toggleFileVisibility(filename, visible) {
            const fileData = loadedFiles.get(filename);
            if (fileData) {
                fileData.visible = visible;
                filterRecipes();
            }
        }

        // Update load status message
        function updateLoadStatus(message, type) {
            const statusEl = document.getElementById('loadStatus');
            statusEl.textContent = message;
            statusEl.style.color = type === 'error' ? '#dc3545' : '#28a745';
            setTimeout(() => {
                statusEl.textContent = '';
            }, 5000);
        }

        // Setup filter buttons (fixed to prevent duplicates)
        function setupFilters() {
            const categories = ['All', ...new Set(recipes.map(r => r.category))].sort();
            const filtersContainer = document.getElementById('filters');

            // Clear existing filters first to prevent duplicates
            filtersContainer.innerHTML = '';

            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn' + (category === currentFilter ? ' active' : '');
                btn.textContent = category;
                btn.onclick = () => {
                    // Toggle functionality: if clicking the active filter, switch back to "All"
                    if (currentFilter === category && category !== 'All') {
                        currentFilter = 'All';
                    } else {
                        currentFilter = category;
                    }

                    // Update button states
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.toggle('active', b.textContent === currentFilter);
                    });

                    filterRecipes();
                    savePreferences(); // Save when filter changes
                };
                filtersContainer.appendChild(btn);
            });
        }

        // Filter recipes based on search, category, and tags
        function filterRecipes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Get recipes from visible files only
            let visibleRecipes = [];
            loadedFiles.forEach((fileData, filename) => {
                if (fileData.visible !== false) {
                    visibleRecipes = visibleRecipes.concat(fileData.recipes);
                }
            });
            recipes = visibleRecipes;

            filteredRecipes = recipes.filter(recipe => {
                // Skip dismissed cards
                if (dismissedCards.has(recipe.id)) return false;

                const matchesCategory = currentFilter === 'All' || recipe.category === currentFilter;

                // Tag filtering - match ALL selected tags (AND logic)
                // Check both the tags array AND the type field
                const matchesTags = selectedTags.length === 0 ||
                    selectedTags.every(tag => {
                        // Check if tag exists in tags array OR matches the type field
                        const inTags = recipe.tags && recipe.tags.includes(tag);
                        const matchesType = recipe.type === tag;
                        return inTags || matchesType;
                    });

                if (!searchTerm) return matchesCategory && matchesTags;

                // Search matching
                const searchLower = searchTerm.toLowerCase();
                const matchesSearch =
                    recipe.name.toLowerCase().includes(searchLower) ||
                    recipe.description.toLowerCase().includes(searchLower) ||
                    recipe.ingredients.some(ing => ing.toLowerCase().includes(searchLower)) ||
                    (recipe.tags && recipe.tags.some(tag => tag.toLowerCase().includes(searchLower))) ||
                    recipe.category.toLowerCase().includes(searchLower);

                return matchesCategory && matchesTags && matchesSearch;
            });

            currentPage = 1; // Reset to first page
            displayCurrentPage();
            extractAllTags();
        }

        // Update statistics
        function updateStats() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredRecipes.length);
            const showing = filteredRecipes.length === 0 ? 0 : endIndex - startIndex;
            document.getElementById('recipeCount').textContent = showing;
            document.getElementById('totalCount').textContent = filteredRecipes.length;
            updatePagination();
        }

        // Display recipes
        function displayRecipes(recipesToDisplay) {
            const grid = document.getElementById('recipeGrid');
            const noResults = document.getElementById('noResults');

            if (recipesToDisplay.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noResults.style.display = 'none';
            grid.innerHTML = '';

            recipesToDisplay.forEach(recipe => {
                const card = createRecipeCard(recipe);
                grid.appendChild(card);
            });
        }

        // Create recipe card
        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            card.id = `recipe-${recipe.id}`;

            const typeTag = recipe.type === 'Vegetarian' ? 'veg' : 'non-veg';

            card.innerHTML = `
                <div class="recipe-header">
                    <div class="recipe-header-left">
                        <div class="recipe-name">${recipe.emoji} ${recipe.name}</div>
                        <div class="recipe-category">${recipe.category}</div>
                    </div>
                    <div class="card-actions">
                        <button class="close-card-mini-btn" onclick="event.stopPropagation(); dismissCard('${recipe.id}')" title="Dismiss card">√ó</button>
                    </div>
                </div>
                <div class="recipe-body">
                    <div class="recipe-meta">
                        <div class="meta-item">‚è±Ô∏è ${recipe.prepTime + recipe.cookTime} min</div>
                        <div class="meta-item">üë• ${recipe.servings} servings</div>
                        <div class="meta-item">üìä ${recipe.difficulty}</div>
                    </div>
                    <div class="recipe-description">${recipe.description}</div>
                    <div class="tags">
                        <span class="tag ${typeTag}">${recipe.type}</span>
                        ${recipe.tags ? recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                    </div>
                </div>
            `;

            // Click handler for recipe name
            card.querySelector('.recipe-name').addEventListener('click', (e) => {
                e.stopPropagation();
                expandRecipe(recipe.id);
            });

            // Click handler for expanding (only on the card body, not the buttons)
            card.querySelector('.recipe-body').addEventListener('click', () => {
                expandRecipe(recipe.id);
            });

            return card;
        }

        // Make element draggable
        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let currentX, currentY;
            let hasConverted = false;

            // Remove any existing listeners first
            handle.onmousedown = null;

            handle.onmousedown = function(e) {
                console.log('Mousedown on header', e.target);

                // Exclude buttons and their contents from dragging
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    console.log('Clicked button, ignoring drag');
                    return;
                }

                console.log('Starting drag');
                e.preventDefault();
                e.stopPropagation();

                // Bring element to front when dragging starts
                bringToFront(element);

                // Get initial mouse position
                pos3 = e.clientX;
                pos4 = e.clientY;

                // Convert from centered positioning to absolute positioning on first drag
                if (!hasConverted) {
                    console.log('Converting from centered positioning');
                    const rect = element.getBoundingClientRect();
                    console.log('Current position:', rect.left, rect.top);

                    // Store the current position
                    currentX = rect.left;
                    currentY = rect.top;

                    element.style.setProperty('left', currentX + 'px', 'important');
                    element.style.setProperty('top', currentY + 'px', 'important');
                    element.style.setProperty('transform', 'none', 'important');
                    element.style.margin = '0';
                    hasConverted = true;
                    console.log('After conversion - stored position:', currentX, currentY);
                }

                document.onmousemove = elementDrag;
                document.onmouseup = closeDragElement;
            };

            function elementDrag(e) {
                e.preventDefault();

                // Calculate the movement delta
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                // Update stored position
                currentX = currentX - pos1;
                currentY = currentY - pos2;

                console.log('Moving to:', currentY, currentX);

                // Apply new position
                element.style.setProperty('top', currentY + 'px', 'important');
                element.style.setProperty('left', currentX + 'px', 'important');
            }

            function closeDragElement() {
                console.log('Drag ended at:', currentY, currentX);
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Make element resizable
        function makeResizable(element) {
            // Check if resize handle already exists
            let resizeHandle = element.querySelector('.resize-handle');
            if (resizeHandle) {
                resizeHandle.remove(); // Remove old one
            }

            resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            resizeHandle.title = 'Drag to resize';
            resizeHandle.innerHTML = '‚ã∞';
            element.appendChild(resizeHandle);

            let startX, startY, startWidth, startHeight;
            let isResizing = false;

            resizeHandle.addEventListener('mousedown', initResize, false);

            function initResize(e) {
                isResizing = true;
                e.preventDefault();
                e.stopPropagation();

                startX = e.clientX;
                startY = e.clientY;

                const computedStyle = window.getComputedStyle(element);
                startWidth = parseInt(computedStyle.width, 10);
                startHeight = parseInt(computedStyle.height, 10);

                document.addEventListener('mousemove', resize, false);
                document.addEventListener('mouseup', stopResize, false);
            }

            function resize(e) {
                if (!isResizing) return;
                e.preventDefault();

                const width = startWidth + (e.clientX - startX);
                const height = startHeight + (e.clientY - startY);

                element.style.width = Math.max(400, width) + 'px';
                element.style.height = Math.max(300, height) + 'px';
            }

            function stopResize(e) {
                isResizing = false;
                e.preventDefault();
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // Expand recipe to show full details - creates a new floating window
        function expandRecipe(id, card) {
            // Check if already has a floating window open
            if (document.getElementById(`floating-${id}`)) {
                // Just bring to front
                const floatingCard = document.getElementById(`floating-${id}`);
                bringToFront(floatingCard);
                return;
            }

            // Find the recipe data
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            // Create floating card
            const floatingCard = createFloatingCard(recipe);
            document.body.appendChild(floatingCard);

            // Bring to front immediately
            bringToFront(floatingCard);

            // Wait a moment for DOM to settle
            setTimeout(() => {
                // Make draggable by header
                const header = floatingCard.querySelector('.recipe-header');
                if (header) {
                    makeDraggable(floatingCard, header);
                }

                // Make resizable
                makeResizable(floatingCard);
            }, 50);
        }

        // Create a floating card window
        function createFloatingCard(recipe) {
            const floatingCard = document.createElement('div');
            floatingCard.className = 'recipe-card expanded floating';
            floatingCard.id = `floating-${recipe.id}`;

            // Set initial position - will be overridden when dragging
            floatingCard.style.position = 'fixed';
            floatingCard.style.top = '10vh';
            floatingCard.style.left = '50%';
            floatingCard.style.transform = 'translateX(-50%)';

            const typeTag = recipe.type === 'Vegetarian' ? 'veg' : 'non-veg';

            floatingCard.innerHTML = `
                <div class="recipe-header">
                    <div class="recipe-header-left">
                        <div class="recipe-name">${recipe.emoji} ${recipe.name}</div>
                        <div class="recipe-category">${recipe.category}</div>
                    </div>
                    <div class="card-actions">
                        <button class="minimize-btn" onclick="dockFloatingRecipe('${recipe.id}')" title="Minimize to dock">‚àí</button>
                        <button class="close-card-btn" onclick="closeFloatingRecipe('${recipe.id}')" title="Close">√ó</button>
                    </div>
                </div>
                <div class="recipe-body">
                    <div class="recipe-meta">
                        <div class="meta-item">‚è±Ô∏è ${recipe.prepTime + recipe.cookTime} min</div>
                        <div class="meta-item">üë• ${recipe.servings} servings</div>
                        <div class="meta-item">üìä ${recipe.difficulty}</div>
                    </div>
                    <div class="recipe-description">${recipe.description}</div>
                    <div class="tags">
                        <span class="tag ${typeTag}">${recipe.type}</span>
                        ${recipe.tags ? recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                    </div>
                </div>
                <div class="expanded-content">
                    <div class="section">
                        <h3>üìù Ingredients</h3>
                        <ul class="ingredients-list">
                            ${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="section">
                        <h3>üë®‚Äçüç≥ Instructions</h3>
                        <ol class="instructions-list">
                            ${recipe.instructions.map(inst => `<li>${inst}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;

            return floatingCard;
        }

        // Close floating recipe window
        function closeFloatingRecipe(id) {
            const floatingCard = document.getElementById(`floating-${id}`);
            if (floatingCard) {
                floatingCard.remove();
            }

            // Also remove from docked if present
            if (dockedCards.has(id)) {
                dockedCards.delete(id);
                updateDockedArea();
            }
        }

        // Dock floating recipe (minimize to docked area)
        function dockFloatingRecipe(id) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            // Add to docked cards
            dockedCards.set(id, recipe);

            // Remove the floating window
            const floatingCard = document.getElementById(`floating-${id}`);
            if (floatingCard) {
                floatingCard.remove();
            }

            // Update docked area
            updateDockedArea();
        }

        // Restore recipe from docked area
        function restoreRecipe(id) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            // Remove from docked
            dockedCards.delete(id);
            updateDockedArea();

            // Create new floating window
            expandRecipe(id);
        }

        // Close from docked area
        function closeDocked(id) {
            dockedCards.delete(id);
            updateDockedArea();
        }

        // Update docked area display
        function updateDockedArea() {
            const dockedArea = document.getElementById('dockedArea');
            const dockedCardsContainer = document.getElementById('dockedCards');

            if (dockedCards.size === 0) {
                dockedArea.classList.remove('active');
                return;
            }

            dockedArea.classList.add('active');
            dockedCardsContainer.innerHTML = '';

            dockedCards.forEach((recipe, id) => {
                const dockedCard = document.createElement('div');
                dockedCard.className = 'docked-card';

                dockedCard.innerHTML = `
                    <div class="docked-card-name">${recipe.emoji} ${recipe.name}</div>
                    <div class="docked-card-actions">
                        <button class="restore-btn" onclick="restoreRecipe('${id}')" title="Restore">‚Üë</button>
                        <button class="close-btn" onclick="closeDocked('${id}')" title="Close">√ó</button>
                    </div>
                `;

                dockedCardsContainer.appendChild(dockedCard);
            });
        }

        // ==================== Preferences Management ====================

        // Save preferences to localStorage
        function savePreferences() {
            const prefs = {
                theme: currentTheme,
                searchQuery: document.getElementById('searchInput').value,
                selectedTags: selectedTags,
                currentFilter: currentFilter,
                itemsPerPage: itemsPerPage === filteredRecipes.length ? 'all' : itemsPerPage
            };
            localStorage.setItem('recipePreferences', JSON.stringify(prefs));
        }

        // Load preferences from localStorage
        function loadPreferences() {
            const saved = localStorage.getItem('recipePreferences');
            if (!saved) return null;

            try {
                return JSON.parse(saved);
            } catch (e) {
                console.error('Error parsing saved preferences:', e);
                return null;
            }
        }

        // Apply preferences from object
        function applyPreferences(prefs) {
            if (!prefs) return;

            // Apply theme
            if (prefs.theme) {
                setTheme(prefs.theme);
            }

            // Apply search query
            if (prefs.searchQuery) {
                document.getElementById('searchInput').value = prefs.searchQuery;
            }

            // Apply selected tags
            if (prefs.selectedTags && Array.isArray(prefs.selectedTags)) {
                selectedTags = prefs.selectedTags;
                renderSelectedTags();
            }

            // Apply category filter
            if (prefs.currentFilter) {
                currentFilter = prefs.currentFilter;
            }

            // Apply items per page
            if (prefs.itemsPerPage) {
                const select = document.getElementById('itemsPerPageSelect');
                select.value = prefs.itemsPerPage;
                itemsPerPage = prefs.itemsPerPage === 'all' ? filteredRecipes.length : parseInt(prefs.itemsPerPage);
            }

            // Re-filter with loaded preferences
            filterRecipes();
        }

        // Get URL parameters
        function getURLParameters() {
            const params = new URLSearchParams(window.location.search);
            const prefs = {};

            if (params.has('theme')) prefs.theme = params.get('theme');
            if (params.has('search')) prefs.searchQuery = params.get('search');
            if (params.has('tags')) prefs.selectedTags = params.get('tags').split(',').filter(t => t);
            if (params.has('category')) prefs.currentFilter = params.get('category');
            if (params.has('items')) prefs.itemsPerPage = params.get('items');

            return Object.keys(prefs).length > 0 ? prefs : null;
        }

        // Generate shareable URL with current preferences
        function sharePreferences() {
            const params = new URLSearchParams();

            if (currentTheme !== 'light') params.set('theme', currentTheme);

            const search = document.getElementById('searchInput').value;
            if (search) params.set('search', search);

            if (selectedTags.length > 0) params.set('tags', selectedTags.join(','));

            if (currentFilter !== 'All') params.set('category', currentFilter);

            const itemsValue = document.getElementById('itemsPerPageSelect').value;
            if (itemsValue !== '10') params.set('items', itemsValue);

            const url = params.toString()
                ? `${window.location.origin}${window.location.pathname}?${params.toString()}`
                : window.location.origin + window.location.pathname;

            // Copy to clipboard
            navigator.clipboard.writeText(url).then(() => {
                // Show success message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = 'linear-gradient(135deg, #52b788 0%, #2d6a4f 100%)';
                btn.style.color = 'white';
                btn.style.borderColor = 'transparent';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }, 2000);
            }).catch(err => {
                // Fallback: show URL in prompt
                prompt('Share this URL:', url);
            });
        }

        // Clear all saved preferences
        function clearPreferences() {
            if (confirm('Clear all saved preferences and reload with defaults?')) {
                localStorage.removeItem('recipePreferences');
                localStorage.removeItem('selectedTheme'); // Also clear theme
                // Reload page without URL parameters
                window.location.href = window.location.origin + window.location.pathname;
            }
        }

        // Auto-save preferences when they change
        function setupAutoSave() {
            // Save on search change
            document.getElementById('searchInput').addEventListener('input', () => {
                setTimeout(savePreferences, 500); // Debounce
            });

            // Save on theme change (handled in setTheme)
            // Save on tag change (handled in addTag/removeTag)
            // Save on filter change (handled in filter click)
            // Save on items per page change (handled in changeItemsPerPage)
        }

        // Search functionality with real-time filtering
        document.getElementById('searchInput').addEventListener('input', filterRecipes);

        // Tag input listener for suggestions
        document.getElementById('tagInput').addEventListener('input', (e) => {
            showTagSuggestions(e.target.value);
        });

        // Tag input keydown listener for Enter key
        document.getElementById('tagInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('tagSuggestions').style.display === 'block') {
                // Add first suggestion
                const firstSuggestion = document.querySelector('.tag-suggestion-item');
                if (firstSuggestion) {
                    firstSuggestion.click();
                }
            }
        });

        // Click outside to close tag suggestions
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tag-input-wrapper')) {
                hideTagSuggestions();
            }
        });

        // Items per page selector
        document.getElementById('itemsPerPageSelect').addEventListener('change', changeItemsPerPage);

        // Initialize
        async function initializeApp() {
            // Load recipes first
            await loadRecipes();

            // Check for URL parameters (priority over localStorage)
            const urlParams = getURLParameters();

            if (urlParams) {
                // URL parameters take precedence
                applyPreferences(urlParams);
            } else {
                // Load from localStorage
                const savedPrefs = loadPreferences();
                if (savedPrefs) {
                    applyPreferences(savedPrefs);
                } else {
                    // No saved preferences, use defaults
                    const savedTheme = localStorage.getItem('selectedTheme') || 'light';
                    setTheme(savedTheme);
                }
            }

            // Setup auto-save for future changes
            setupAutoSave();
        }

        // Start the app
        initializeApp();
    </script>
</body>
</html>
